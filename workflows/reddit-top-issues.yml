on:
  reddit:
    url: https://www.reddit.com/r/all/top/.json?t=week
    source: json
    config:
      # limit: 2
      every: "33 8 * * *"
      outputsMode: combine
      exportOutputs: true
      format: |
        delete item.all_awardings
        return item
      filterScript: |
        if(item.score>130000){
          return true
        }
    requestConfig:
      params:
        raw_json: 1
jobs:
  save:
    name: save to json
    runs-on: ubuntu-latest
    steps:
      - name: Format reddit JSON
        env:
          OUTPUTS_PATH: ${{ on.reddit.outputs.path }}
        uses: ./.github/actions/format
        with:
          function: reddit
      - name: Create Reddit JSON
        uses: actions/github-script@v2
        env:
          OUTPUTS_PATH: ${{ on.reddit.outputs.path }}
        with:
          script: |
            const generateSources = require(`${process.env.GITHUB_WORKSPACE}/scripts/generate-reddit-top-weekly-module.js`)
            await generateSources()
            return true
      - name: Create Pull Request
        uses: theowenyoung/create-pull-request@master
        if: env.ACTIONS_LOCAL!='true'
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          commit-message: "chore: new item"
          branch: new-issue-item
          delete-branch: true
          title: New item update
